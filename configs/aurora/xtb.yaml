name: xtb
hpc_system: aurora
endpoint_id: 608403f7-58df-44f6-a27b-b6084cae113d
environment:
  modules: []
  conda_env: xtb_env
  conda_packages:
    - xtb
  env_vars:
    OMP_NUM_THREADS: '4'
  setup_commands:
    - source /opt/aurora/25.190.0/oneapi/intel-conda-miniforge/etc/profile.d/conda.sh
    - conda activate xtb_env
installation:
  steps:
    - conda create -n xtb_env -c conda-forge xtb python=3.11 -y
  verification: |
    source /opt/aurora/25.190.0/oneapi/intel-conda-miniforge/etc/profile.d/conda.sh && \
    conda activate xtb_env && \
    xtb --version
execution:
  function: |
    def run_xtb(xyz_input=None, task="energy", charge=0, uhf=0, output_dir="xtb_output"):
        """
        Run xtb calculation via subprocess with conda activation.

        Args:
            xyz_input: XYZ format string or None for test
            task: 'energy', 'optimize', or 'md'
            charge: molecular charge
            uhf: number of unpaired electrons
        """
        import subprocess
        import os
        import tempfile

        output_dir = os.path.abspath(output_dir)
        os.makedirs(output_dir, exist_ok=True)

        # Default test molecule
        if xyz_input is None:
            xyz_input = """3
Water
O  0.000  0.000  0.117
H  0.000  0.757 -0.469
H  0.000 -0.757 -0.469
"""

        # Write XYZ file
        xyz_file = os.path.join(output_dir, "input.xyz")
        with open(xyz_file, "w") as f:
            f.write(xyz_input)

        # Build command
        cmd_parts = ["xtb", xyz_file, f"--chrg", str(charge), f"--uhf", str(uhf)]
        if task == "optimize":
            cmd_parts.append("--opt")
        elif task == "md":
            cmd_parts.extend(["--md", "--temp", "300"])

        # Run with conda activation
        conda_activate = "source /opt/aurora/25.190.0/oneapi/intel-conda-miniforge/etc/profile.d/conda.sh && conda activate xtb_env && "
        cmd = conda_activate + " ".join(cmd_parts)

        result = subprocess.run(
            cmd, shell=True, capture_output=True, text=True,
            cwd=output_dir, timeout=300
        )

        # Parse output
        output = result.stdout + result.stderr
        energy = None
        for line in output.split("\n"):
            if "TOTAL ENERGY" in line:
                try:
                    energy = float(line.split()[-3])
                except:
                    pass

        return {
            "status": "completed" if result.returncode == 0 else "failed",
            "task": task,
            "energy_hartree": energy,
            "output_dir": output_dir,
            "stdout": output[-2000:] if len(output) > 2000 else output
        }
  function_name: run_xtb
  resources:
    nodes: 1
    cores_per_node: 8
    memory_gb: 32
    walltime: 01:00:00
  pre_commands: []
  post_commands: []
discovery_log:
  discovered_date: '2026-02-11'
  attempts: 1
  notes: 'xtb semi-empirical quantum chemistry on Aurora via conda.'
tags: [quantum_chemistry, semi_empirical, gfn2]
