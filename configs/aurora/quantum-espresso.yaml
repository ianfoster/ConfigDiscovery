name: quantum-espresso
hpc_system: aurora
endpoint_id: 608403f7-58df-44f6-a27b-b6084cae113d
environment:
  conda_env: qe_env
  conda_packages:
    - qe=7.5
  setup_commands:
    - source /opt/aurora/25.190.0/oneapi/intel-conda-miniforge/etc/profile.d/conda.sh
    - conda activate qe_env
installation:
  steps:
    - conda create -n qe_env -c conda-forge qe=7.5 python=3.11 -y
  verification: |
    source /opt/aurora/25.190.0/oneapi/intel-conda-miniforge/etc/profile.d/conda.sh && \
    conda activate qe_env && which pw.x
execution:
  function: |
    def run_qe(input_file=None, output_dir="qe_output", pseudo_dir=None):
        """Run Quantum ESPRESSO pw.x calculation."""
        import subprocess
        import os

        output_dir = os.path.abspath(output_dir)
        os.makedirs(output_dir, exist_ok=True)

        # Simple H atom test
        if input_file is None:
            input_file = """
&CONTROL
  calculation = 'scf'
  pseudo_dir = './pseudo'
  outdir = './tmp'
/
&SYSTEM
  ibrav = 1
  celldm(1) = 20.0
  nat = 1
  ntyp = 1
  ecutwfc = 30.0
/
&ELECTRONS
  conv_thr = 1.0d-6
/
ATOMIC_SPECIES
  H  1.008  H.pbe-rrkjus_psl.1.0.0.UPF
ATOMIC_POSITIONS angstrom
  H 0.0 0.0 0.0
K_POINTS gamma
"""

        input_path = os.path.join(output_dir, "input.in")
        with open(input_path, "w") as f:
            f.write(input_file)

        conda_activate = "source /opt/aurora/25.190.0/oneapi/intel-conda-miniforge/etc/profile.d/conda.sh && conda activate qe_env && "
        cmd = f"{conda_activate}pw.x < {input_path}"

        result = subprocess.run(
            cmd, shell=True, capture_output=True, text=True,
            cwd=output_dir, timeout=600
        )

        output = result.stdout + result.stderr
        energy = None
        for line in output.split("\n"):
            if "!    total energy" in line:
                try:
                    energy = float(line.split()[-2])
                except:
                    pass

        return {
            "status": "completed" if result.returncode == 0 else "failed",
            "total_energy_Ry": energy,
            "output_dir": output_dir,
            "stdout": output[-1500:]
        }
  function_name: run_qe
  resources:
    nodes: 1
    cores_per_node: 8
    memory_gb: 64
    walltime: 02:00:00
discovery_log:
  discovered_date: '2026-02-11'
  attempts: 1
  notes: 'Quantum ESPRESSO 7.5 on Aurora via conda-forge.'
tags: [dft, periodic, materials, plane_wave]
