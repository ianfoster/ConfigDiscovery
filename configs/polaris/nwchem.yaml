name: nwchem
version: "7.2.0"
description: |
  NWChem is an open-source computational chemistry package designed to run on
  high-performance parallel supercomputers and conventional workstations.
  It provides methods for computing ground and excited-state properties of
  large molecules using various electronic structure theories including
  Hartree-Fock, DFT, MP2, and Coupled Cluster. NWChem also supports plane-wave
  DFT for periodic systems and classical molecular dynamics.

hpc_system: polaris
endpoint_id: 0554c761-5a62-474d-b26e-df7455682bba

environment:
  modules: []
  conda_env: nwchem_env
  conda_packages:
    - python=3.11
    - nwchem=7.2.0=py311he9addbd_2
  pip_packages: []
  env_vars:
    OMPI_MCA_btl_vader_single_copy_mechanism: "none"  # Avoid MPI shared memory warnings
  setup_commands:
    - source /soft/applications/conda/2025-09-25/mconda3/etc/profile.d/conda.sh
    - conda activate nwchem_env
    - export OMPI_MCA_btl_vader_single_copy_mechanism=none

installation:
  prerequisites:
    - Conda (miniconda or anaconda)
    - "On Polaris: conda is available at /soft/applications/conda/"
  steps:
    - "# Initialize conda"
    - source /soft/applications/conda/2025-09-25/mconda3/etc/profile.d/conda.sh
    - "# Create environment"
    - conda create -n nwchem_env python=3.11 -y
    - conda activate nwchem_env
    - "# Install NWChem from conda-forge"
    - conda install -c conda-forge nwchem=7.2.0 -y
  verification: nwchem --version 2>&1 | head -5 || echo 'NWChem installed successfully'
  notes: |
    The conda-forge NWChem package is built with OpenMPI support for parallel
    calculations. For single-node runs, no special MPI configuration is needed.

    Important: Set OMPI_MCA_btl_vader_single_copy_mechanism=none to avoid
    shared memory warnings that can cause issues on some systems.

    NWChem uses its own input file format (.nw files). The code supports
    many basis sets via the "library" keyword that references built-in
    basis set definitions.

execution:
  function: |
    def run_nwchem(calculation_type="energy", method="rhf", basis="6-31g"):
        """
        Run NWChem quantum chemistry calculations.

        Parameters:
        -----------
        calculation_type : str
            Type of calculation:
            - 'energy': Single-point energy
            - 'optimize': Geometry optimization
            - 'freq': Vibrational frequencies (after energy)
        method : str
            Electronic structure method:
            - 'rhf' or 'scf': Restricted Hartree-Fock
            - 'uhf': Unrestricted Hartree-Fock
            - 'dft': Density Functional Theory (uses B3LYP)
            - 'mp2': Second-order MÃ¸ller-Plesset
            - 'ccsd': Coupled Cluster Singles and Doubles
        basis : str
            Basis set name. NWChem supports many standard basis sets:
            - 'sto-3g': Minimal basis
            - '6-31g': Split-valence (good for organics)
            - '6-31g*': With polarization
            - 'cc-pvdz': Correlation-consistent double-zeta
            - 'cc-pvtz': Correlation-consistent triple-zeta
            - 'aug-cc-pvdz': With diffuse functions

        Returns:
        --------
        dict : Results including SCF/DFT energy in hartree

        Example:
        --------
        # Hartree-Fock energy
        result = run_nwchem(method='rhf', basis='6-31g')

        # DFT optimization
        result = run_nwchem(calculation_type='optimize', method='dft',
                           basis='6-31g*')
        """
        import subprocess
        import os
        import tempfile
        import re
        import textwrap

        output_dir = tempfile.mkdtemp(prefix='nwchem_')
        calc_name = "nwchem_job"

        # Build theory-specific input blocks
        if method.lower() == "dft":
            theory_block = "dft\n  xc b3lyp\nend"
            task_line = f"task dft {calculation_type}"
        elif method.lower() in ["mp2", "ccsd"]:
            theory_block = ""
            task_line = f"task {method} {calculation_type}"
        else:
            theory_block = ""
            task_line = f"task scf {calculation_type}"

        # NWChem input file (uses water as default test molecule)
        input_content = textwrap.dedent(f"""
            start {calc_name}
            title "Water molecule {method}/{basis} {calculation_type}"

            memory 1000 mb

            geometry units angstrom
              O  0.000000  0.000000  0.117489
              H  0.756950  0.000000 -0.469957
              H -0.756950  0.000000 -0.469957
            end

            basis
              * library {basis}
            end
            {theory_block}
            {task_line}
        """)

        # Shell script with conda activation
        run_script = textwrap.dedent(f"""
            #!/bin/bash
            source /soft/applications/conda/2025-09-25/mconda3/etc/profile.d/conda.sh
            conda activate nwchem_env

            # Suppress MPI shared memory warnings
            export OMPI_MCA_btl_vader_single_copy_mechanism=none

            cd {output_dir}
            nwchem {calc_name}.nw > {calc_name}.out 2>&1

            if grep -q "Total SCF energy" {calc_name}.out || grep -q "Total DFT energy" {calc_name}.out; then
                echo "SUCCESS"
            else
                echo "FAILED"
            fi
        """)

        # Write input files
        input_path = os.path.join(output_dir, f"{calc_name}.nw")
        script_path = os.path.join(output_dir, "run_nwchem.sh")

        with open(input_path, "w") as f:
            f.write(input_content)

        with open(script_path, "w") as f:
            f.write(run_script)

        os.chmod(script_path, 0o755)

        result = subprocess.run(
            ["bash", script_path],
            capture_output=True,
            text=True,
            cwd=output_dir
        )

        # Parse results
        output_file = os.path.join(output_dir, f"{calc_name}.out")
        results = {
            "calculation_type": calculation_type,
            "method": method,
            "basis": basis,
            "output_dir": output_dir,
            "input_file": input_path,
            "output_file": output_file
        }

        if os.path.exists(output_file):
            with open(output_file, "r") as f:
                content = f.read()

            scf_match = re.search(r'Total SCF energy\s*=\s*([-\d.]+)', content)
            if scf_match:
                results["scf_energy_hartree"] = float(scf_match.group(1))
                results["status"] = "completed"

            dft_match = re.search(r'Total DFT energy\s*=\s*([-\d.]+)', content)
            if dft_match:
                results["dft_energy_hartree"] = float(dft_match.group(1))
                results["status"] = "completed"

            if "Optimization converged" in content:
                results["optimization_converged"] = True

            if "status" not in results:
                results["status"] = "failed"
                results["error"] = content[-2000:] if len(content) > 2000 else content
        else:
            results["status"] = "failed"
            results["error"] = result.stderr or "No output file generated"
            results["stdout"] = result.stdout

        return results
  function_name: run_nwchem
  resources:
    nodes: 1
    cores_per_node: 32
    memory_gb: 64
    walltime: "01:00:00"
    queue: debug-cache-quad
  pre_commands: []
  post_commands: []

discovery_log:
  discovered_date: "2026-02-10"
  discovery_method: "LLM-guided exploration via Globus Compute"
  docs_consulted:
    - https://nwchemgit.github.io/Home.html
  attempts: 39
  notes: |
    Successfully installed NWChem 7.2.0 via conda-forge. The package includes
    OpenMPI support for parallel calculations.

    Tested with a water molecule RHF/6-31g calculation. Energy converged to
    -75.983927205644 hartree.

    Important configuration: Set OMPI_MCA_btl_vader_single_copy_mechanism=none
    to avoid shared memory transport warnings that can cause issues.

    Key finding: Execution functions must use subprocess with explicit conda
    activation because Globus Compute workers don't inherit the conda environment.
  claude_model: claude-sonnet-4-20250514

tags:
  - quantum-chemistry
  - electronic-structure
  - dft
  - hartree-fock
  - mpi-parallel
